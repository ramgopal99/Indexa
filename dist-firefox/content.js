import{r as v}from"./assets/browser-api-CF00Ueln.js";class y{searchContainer=null;searchInput=null;isVisible=!1;topics=[];filteredTopics=[];onFilterChange;constructor(e){this.onFilterChange=e,this.createContainer()}createContainer(){this.searchContainer=document.createElement("div"),this.searchContainer.className="search-container",this.searchContainer.id="search-container",this.searchContainer.style.display="none";const e=document.createElement("div");e.className="search-input-wrapper",this.searchInput=document.createElement("input"),this.searchInput.type="text",this.searchInput.id="search-input",this.searchInput.className="search-input",this.searchInput.placeholder="Search topics...",this.searchInput.addEventListener("input",o=>{this.filterTopics(o.target.value)});const s=document.createElement("button");s.className="search-close-button",s.title="Close search",s.innerHTML=`
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M18 6 6 18"/>
        <path d="m6 6 12 12"/>
      </svg>
    `,s.addEventListener("click",()=>{this.toggle()}),e.appendChild(this.searchInput),e.appendChild(s),this.searchContainer.appendChild(e)}getContainer(){return this.searchContainer}setTopics(e){this.topics=e}toggle(){if(this.searchContainer)if(this.isVisible=!this.isVisible,this.isVisible)this.searchContainer.style.display="block",this.searchInput?.focus();else{this.searchContainer.style.display="none",this.searchInput&&(this.searchInput.value=""),this.filteredTopics=[];const e=this.topics.map(s=>({...s,highlightedText:void 0}));this.onFilterChange(e,!1)}}filterTopics(e){if(!e.trim()){this.filteredTopics=[];const o=this.topics.map(t=>({...t,highlightedText:void 0}));this.onFilterChange(o,!1);return}const s=e.toLowerCase();this.filteredTopics=this.topics.filter(o=>o.text.toLowerCase().includes(s)).map(o=>{const t=this.highlightText(o.text,e);return{...o,highlightedText:t}}),this.onFilterChange(this.filteredTopics,!0)}highlightText(e,s){if(!s.trim())return e;const o=new RegExp(`(${this.escapeRegExp(s)})`,"gi");return e.replace(o,'<span class="search-highlight">$1</span>')}escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}}class C{settingsDropdown=null;currentTheme="light";sidebarElement=null;isDropdownOpen=!1;studyModeEnabled=!1;onStudyModeChange;constructor(){this.loadSavedTheme(),this.loadStudyModeSettings()}setSidebarElement(e){this.sidebarElement=e,this.applyTheme()}toggleSettingsDropdown(e){this.settingsDropdown||this.createSettingsDropdown(),this.isDropdownOpen?this.hideSettingsDropdown():this.showSettingsDropdown(e)}showSettingsDropdown(e){this.settingsDropdown&&(this.isDropdownOpen=!0,this.settingsDropdown.classList.add("settings-dropdown-visible"),e&&this.positionDropdown(e))}hideSettingsDropdown(){this.settingsDropdown&&(this.isDropdownOpen=!1,this.settingsDropdown.classList.remove("settings-dropdown-visible"))}positionDropdown(e){if(!this.settingsDropdown)return;const s=e.getBoundingClientRect(),o=this.settingsDropdown.querySelector(".settings-dropdown");if(o){const a=Math.max(10,s.right-200-10),i=s.bottom+8;o.style.position="fixed",o.style.left=`${a}px`,o.style.top=`${i}px`,o.style.zIndex="10000"}}createSettingsDropdown(){if(this.settingsDropdown)return;const e=document.createElement("div");e.className="settings-dropdown-container";const s=document.createElement("div");s.className="settings-dropdown",this.currentTheme==="dark"&&s.classList.add("dark");const o=document.createElement("div");o.className="settings-dropdown-body";const t=document.createElement("div");t.className="settings-section";const a=document.createElement("button");a.className="theme-toggle-btn",a.textContent=this.currentTheme==="dark"?"‚òÄÔ∏è Light Mode":"üåô Dark Mode",a.classList.toggle("dark-mode",this.currentTheme==="dark"),a.addEventListener("click",()=>{this.toggleTheme()}),t.appendChild(a),o.appendChild(t);const i=document.createElement("div");i.className="settings-section";const n=document.createElement("button");n.className="study-mode-toggle-btn",n.textContent=this.studyModeEnabled?"üìö Study Mode: ON":"üìñ Study Mode: OFF",n.classList.toggle("study-mode-active",this.studyModeEnabled),n.addEventListener("click",()=>{this.toggleStudyMode()}),i.appendChild(n),o.appendChild(i),s.appendChild(o),e.appendChild(s),this.settingsDropdown=e,document.body.appendChild(e),setTimeout(()=>{document.addEventListener("click",this.handleClickOutside.bind(this))},0)}handleClickOutside(e){if(!this.settingsDropdown||!this.isDropdownOpen)return;const s=e.target,o=this.settingsDropdown.contains(s),t=document.querySelector(".settings-button"),a=t&&t.contains(s);!o&&!a&&this.hideSettingsDropdown()}loadSavedTheme(){const e=localStorage.getItem("side-indexer-theme");this.currentTheme=e||"light",this.applyTheme()}saveTheme(){localStorage.setItem("side-indexer-theme",this.currentTheme)}applyTheme(){if(this.sidebarElement&&(this.currentTheme==="dark"?this.sidebarElement.classList.add("dark"):this.sidebarElement.classList.remove("dark")),this.settingsDropdown){const e=this.settingsDropdown.querySelector(".settings-dropdown");e&&(this.currentTheme==="dark"?e.classList.add("dark"):e.classList.remove("dark"))}}toggleTheme(){this.currentTheme=this.currentTheme==="light"?"dark":"light",this.saveTheme(),this.applyTheme(),this.updateThemeToggleUI()}getCurrentTheme(){return this.currentTheme}updateThemeToggleUI(){if(!this.settingsDropdown)return;const e=this.settingsDropdown.querySelector(".theme-toggle-btn");if(e){const s=this.currentTheme==="dark";e.textContent=s?"‚òÄÔ∏è Light Mode":"üåô Dark Mode",e.classList.toggle("dark-mode",s)}}loadStudyModeSettings(){const e=localStorage.getItem("side-indexer-study-mode")==="true";this.studyModeEnabled=e}saveStudyModeSettings(){localStorage.setItem("side-indexer-study-mode",this.studyModeEnabled.toString())}toggleStudyMode(){this.studyModeEnabled=!this.studyModeEnabled,this.saveStudyModeSettings(),this.updateStudyModeToggleUI(),this.onStudyModeChange?.(this.studyModeEnabled)}setStudyModeChangeCallback(e){this.onStudyModeChange=e}isStudyModeEnabled(){return this.studyModeEnabled}updateStudyModeToggleUI(){if(!this.settingsDropdown)return;const e=this.settingsDropdown.querySelector(".study-mode-toggle-btn");e&&(e.textContent=this.studyModeEnabled?"üìö Study Mode: ON":"üìñ Study Mode: OFF",e.classList.toggle("study-mode-active",this.studyModeEnabled))}destroy(){this.settingsDropdown&&(document.body.removeChild(this.settingsDropdown),this.settingsDropdown=null),document.removeEventListener("click",this.handleClickOutside.bind(this))}}class x{header=null;search;settings;constructor(e,s,o){this.search=e,this.settings=s,this.createHeader(o)}createHeader(e){this.header=document.createElement("div"),this.header.className="sidebar-header";const s=document.createElement("div");s.className="sidebar-header-left";const o=document.createElement("h2");o.className="sidebar-title",o.textContent="Indexa",s.appendChild(o);const t=document.createElement("div");t.className="sidebar-header-right";const a=document.createElement("button");a.className="sidebar-header-button search-button",a.title="Search",a.innerHTML=`
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="8"/>
        <path d="m21 21-4.3-4.3"/>
      </svg>
    `,a.addEventListener("click",()=>{this.search.toggle()});const i=document.createElement("button");i.className="sidebar-header-button settings-button",i.title="Settings",i.innerHTML=`
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
        <circle cx="12" cy="12" r="3"/>
      </svg>
    `,i.addEventListener("click",()=>{this.settings.toggleSettingsDropdown(i)});const n=document.createElement("button");n.className="sidebar-header-button close-button",n.title="Close sidebar",n.innerHTML=`
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M18 6 6 18"/>
        <path d="m6 6 12 12"/>
      </svg>
    `,n.addEventListener("click",e),t.appendChild(a),t.appendChild(i),t.appendChild(n),this.header.appendChild(s),this.header.appendChild(t)}getElement(){return this.header}}class E{tabElement=null;isActive=!0;constructor(e){this.createTab(e)}createTab(e){this.tabElement=document.createElement("button"),this.tabElement.className="sidebar-tab active",this.tabElement.innerHTML=`
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="14" height="14" fill="currentColor" style="margin-right: 4px; vertical-align: middle;">
        <path d="M 5 8 A 2.0002 2.0002 0 1 0 5 12 L 45 12 A 2.0002 2.0002 0 1 0 45 8 L 5 8 z M 5 23 A 2.0002 2.0002 0 1 0 5 27 L 45 27 A 2.0002 2.0002 0 1 0 45 23 L 5 23 z M 5 38 A 2.0002 2.0002 0 1 0 5 42 L 45 42 A 2.0002 2.0002 0 1 0 45 38 L 5 38 z"/>
      </svg>
      Menu
    `,this.tabElement.addEventListener("click",e)}setActive(e){this.isActive=e,this.tabElement&&(e?this.tabElement.classList.add("active"):this.tabElement.classList.remove("active"))}isTabActive(){return this.isActive}getElement(){return this.tabElement}}class S{tabElement=null;isActive=!1;constructor(e){this.createTab(e)}createTab(e){this.tabElement=document.createElement("button"),this.tabElement.className="sidebar-tab",this.tabElement.innerHTML=`
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 4px;">
        <path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/>
      </svg>
      Chat
    `,this.tabElement.addEventListener("click",e)}setActive(e){this.isActive=e,this.tabElement&&(e?this.tabElement.classList.add("active"):this.tabElement.classList.remove("active"))}isTabActive(){return this.isActive}getElement(){return this.tabElement}}class T{tabsSection=null;menuTab;chatTab;expandCollapseBtn=null;viewMode="sections";onViewModeChange;onToggleExpandAll;constructor(e,s){this.onViewModeChange=e,this.onToggleExpandAll=s,this.menuTab=new E(()=>this.setViewMode("sections")),this.chatTab=new S(()=>this.setViewMode("chat")),this.createTabsSection()}createTabsSection(){this.tabsSection=document.createElement("div"),this.tabsSection.className="sidebar-tabs-section";const e=document.createElement("div");e.className="sidebar-tabs";const s=this.menuTab.getElement(),o=this.chatTab.getElement();s&&e.appendChild(s),o&&e.appendChild(o),this.expandCollapseBtn=document.createElement("button"),this.expandCollapseBtn.className="sidebar-expand-all-btn",this.expandCollapseBtn.innerHTML=`
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="m9 18 6-6-6-6"/>
      </svg>
    `,this.expandCollapseBtn.title="Collapse All",this.expandCollapseBtn.addEventListener("click",()=>{this.onToggleExpandAll()}),this.tabsSection.appendChild(e),this.tabsSection.appendChild(this.expandCollapseBtn)}setViewMode(e){this.viewMode=e,e==="sections"?(this.menuTab.setActive(!0),this.chatTab.setActive(!1)):(this.menuTab.setActive(!1),this.chatTab.setActive(!0)),this.onViewModeChange(e)}getViewMode(){return this.viewMode}getElement(){return this.tabsSection}getExpandCollapseBtn(){return this.expandCollapseBtn}updateExpandCollapseButton(e){this.expandCollapseBtn&&(e?(this.expandCollapseBtn.innerHTML=`
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="m9 18 6-6-6-6"/>
        </svg>
      `,this.expandCollapseBtn.title="Collapse All"):(this.expandCollapseBtn.innerHTML=`
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="m6 9 6 6 6-6"/>
        </svg>
      `,this.expandCollapseBtn.title="Expand All"))}}class L{tabsContainer;constructor(e,s){this.tabsContainer=new T(e,s)}getViewMode(){return this.tabsContainer.getViewMode()}getElement(){return this.tabsContainer.getElement()}getExpandCollapseBtn(){return this.tabsContainer.getExpandCollapseBtn()}updateExpandCollapseButton(e){this.tabsContainer.updateExpandCollapseButton(e)}}class k{topicsList=null;customLabels=new Map;STORAGE_KEY="side-indexer-custom-labels";STUDY_STORAGE_KEY="side-indexer-study-checked";onLabelsChanged;isStudyModeEnabled=!1;studyCheckedTopics=new Set;constructor(e){this.onLabelsChanged=e,this.createTopicsList(),this.loadCustomLabels(),this.loadStudyCheckedTopics()}loadCustomLabels(){try{const e=localStorage.getItem(this.STORAGE_KEY);if(e){const s=JSON.parse(e);this.customLabels=new Map(Object.entries(s))}}catch(e){console.warn("Failed to load custom labels from localStorage:",e)}}saveCustomLabels(){try{const e=Object.fromEntries(this.customLabels);localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}catch(e){console.warn("Failed to save custom labels to localStorage:",e)}}getTopicKey(e){const s=e.type?`${e.type}:${e.text}`:`section:${e.text}`,o=Array.from(e.element.parentElement?.children||[]).indexOf(e.element);return`${s}:${o}`}setCustomLabel(e,s){const o=this.getTopicKey(e);s.trim()?this.customLabels.set(o,s.trim()):this.customLabels.delete(o),this.saveCustomLabels(),this.onLabelsChanged?.()}getCustomLabel(e){const s=this.getTopicKey(e);return this.customLabels.get(s)}setStudyMode(e,s,o){this.isStudyModeEnabled=e,this.updateTopicsList(s,o,!1)}isTopicChecked(e){const s=this.getTopicKey(e);return this.studyCheckedTopics.has(s)}toggleTopicChecked(e){const s=this.getTopicKey(e);this.studyCheckedTopics.has(s)?this.studyCheckedTopics.delete(s):this.studyCheckedTopics.add(s),this.saveStudyCheckedTopics()}loadStudyCheckedTopics(){try{const e=localStorage.getItem(this.STUDY_STORAGE_KEY);if(e){const s=JSON.parse(e);this.studyCheckedTopics=new Set(s)}}catch(e){console.warn("Failed to load study checked topics from localStorage:",e)}}saveStudyCheckedTopics(){try{const e=Array.from(this.studyCheckedTopics);localStorage.setItem(this.STUDY_STORAGE_KEY,JSON.stringify(e))}catch(e){console.warn("Failed to save study checked topics to localStorage:",e)}}createTopicsList(){this.topicsList=document.createElement("div"),this.topicsList.className="topics-list",this.topicsList.id="topics-list",this.topicsList.innerHTML='<div class="no-topics">No topics found yet</div>'}updateTopicsList(e,s,o=!1){if(!this.topicsList)return;if(e.length===0){this.topicsList.innerHTML='<div class="no-topics">No topics found yet</div>';return}const t=s==="chat"?e.filter(i=>i.type==="user"||i.type==="ai"):e.filter(i=>!i.type);console.log("Total topics found:",e.length),console.log("Filtered topics for",s,":",t.length),console.log("Chat topics:",e.filter(i=>i.type==="user"||i.type==="ai").length),console.log("Section topics:",e.filter(i=>!i.type).length);const a=new Array(t.length).fill(!1);for(let i=0;i<t.length;i++){const n=t[i].level;for(let l=i+1;l<t.length&&!(t[l].level<=n);l++)if(t[l].level===n+1){a[i]=!0;break}}this.topicsList.innerHTML=t.map((i,n)=>{const l=a[n],c=(i.level-1)*20,h=this.isStudyModeEnabled&&s==="sections",d=l?'<span class="expand-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg></span>':h||s==="chat"?"":'<span class="expand-icon-placeholder"></span>',u=s==="chat"&&i.type?i.type==="user"?"You:":"AI:":`H${i.level}`,r=this.getCustomLabel(i),g=i.highlightedText||r||i.text,b=this.isTopicChecked(i),f=h?`<input type="checkbox" class="study-checkbox" ${b?"checked":""} data-topic-index="${n}">`:"",w=h?(h?l?29:36:0)+c:c;return`
      <div class="topic-item ${l?"has-children expanded":""} ${i.type||""} ${o?"search-result":""}" data-index="${n}" data-level="${i.level}">
        ${f}
        <div class="topic-text" style="padding-left: ${w}px;">
          ${d}
          <span class="heading-label h${i.level} ${i.type||""}">${u}</span>
          <span class="topic-content">${g}</span>
        </div>
      </div>
    `}).join(""),t.forEach((i,n)=>{const l=this.topicsList?.querySelector(`[data-index="${n}"]`);if(!l)return;const c=l.querySelector(".expand-icon");a[n]&&c&&c.addEventListener("click",u=>{u.stopPropagation(),l.classList.contains("expanded")?(l.classList.remove("expanded"),c.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>',this.hideChildren(n,i.level)):(l.classList.add("expanded"),c.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>',this.showChildren(n,i.level))}),l.addEventListener("click",u=>{u.target.classList.contains("expand-icon")||u.target.classList.contains("study-checkbox")||(i.element.scrollIntoView({behavior:"smooth",block:"center"}),i.element.classList.add("side-indexer-highlight"),setTimeout(()=>{i.element.classList.add("fade-out"),setTimeout(()=>{i.element.classList.remove("side-indexer-highlight","fade-out")},500)},1500))});const d=l.querySelector(".topic-text");if(d&&d.addEventListener("dblclick",u=>{u.stopPropagation(),this.startInlineEditing(l,i)}),this.isStudyModeEnabled&&s==="sections"){const u=l.querySelector(".study-checkbox");u&&(u.addEventListener("change",r=>{r.stopPropagation(),this.toggleTopicChecked(i)}),u.addEventListener("click",r=>{r.stopPropagation()}))}})}hideChildren(e,s){if(!this.topicsList)return;this.topicsList.querySelectorAll(".topic-item").forEach((t,a)=>{if(a>e)if(parseInt(t.dataset.level||"1")>s){const n=t;n.style.display="none"}else return})}showChildren(e,s){if(!this.topicsList)return;const o=this.topicsList.querySelectorAll(".topic-item");o.forEach((t,a)=>{if(a>e){const i=parseInt(t.dataset.level||"1"),n=t;if(i<=s)return;if(i===s+1){if(n.style.display="",n.classList.contains("has-children")&&!n.classList.contains("expanded")){n.classList.add("expanded");const l=n.querySelector(".expand-icon");l&&(l.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>')}}else if(i>s+1){let l=!0,c=i-1,h=a-1;for(;c>s&&h>=0;){const d=o[h];if(parseInt(d.dataset.level||"1")===c){if(!d.classList.contains("expanded")){l=!1;break}c--}h--}if(l){if(n.style.display="",n.classList.contains("has-children")&&!n.classList.contains("expanded")){n.classList.add("expanded");const d=n.querySelector(".expand-icon");d&&(d.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>')}}else n.style.display="none"}}})}toggleExpandAll(e){if(!this.topicsList)return;const s=Array.from(this.topicsList.querySelectorAll(".topic-item.has-children"));e?s.forEach(o=>{const t=o;t.classList.remove("expanded");const a=t.querySelector(".expand-icon");a&&(a.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>');const i=parseInt(t.dataset.level||"1"),n=parseInt(t.dataset.index||"0");this.hideChildren(n,i)}):s.forEach(o=>{const t=o;t.classList.add("expanded");const a=t.querySelector(".expand-icon");a&&(a.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>');const i=parseInt(t.dataset.level||"1"),n=parseInt(t.dataset.index||"0");this.showChildren(n,i)})}startInlineEditing(e,s){const t=e.querySelector(".topic-text").querySelector(".topic-content");if(!t)return;const a=this.getCustomLabel(s)||s.text;t.contentEditable="true",t.style.outline="none",t.style.border="1px solid #007acc",t.style.borderRadius="3px",t.style.padding="2px 4px",t.style.backgroundColor="white",t.style.minWidth="50px",t.style.display="inline-block";const i=window.getSelection(),n=document.createRange();n.selectNodeContents(t),i?.removeAllRanges(),i?.addRange(n),e.classList.add("editing");const l=()=>{this.saveInlineEdit(t,s,e)},c=d=>{d.key==="Enter"?(d.preventDefault(),t.blur()):d.key==="Escape"&&(d.preventDefault(),t.textContent=a,t.blur())};t.addEventListener("blur",l),t.addEventListener("keydown",c);const h=t;h._blurHandler=l,h._keydownHandler=c,t.focus()}saveInlineEdit(e,s,o){const t=e.textContent?.trim()||"";e.contentEditable="false",e.style.outline="",e.style.border="",e.style.borderRadius="",e.style.padding="",e.style.backgroundColor="",e.style.minWidth="",e.style.display="",o.classList.remove("editing"),t&&t!==s.text?this.setCustomLabel(s,t):t?t===s.text&&this.setCustomLabel(s,""):(e.textContent=s.text,this.setCustomLabel(s,""));const a=e;a._blurHandler&&e.removeEventListener("blur",a._blurHandler),a._keydownHandler&&e.removeEventListener("keydown",a._keydownHandler)}getElement(){return this.topicsList}}class M{sidebar=null;topics=[];observer=null;search;settings;viewMode="sections";allExpanded=!0;sidebarHeader;sidebarTabs;sidebarTopicsList;constructor(){this.search=new y((e,s=!1)=>{this.updateTopicsList(e.length>0?e:this.topics,s)}),this.settings=new C,this.sidebarHeader=new x(this.search,this.settings,()=>this.hideSidebar()),this.sidebarTabs=new L(e=>this.handleViewModeChange(e),()=>this.toggleExpandAll()),this.sidebarTopicsList=new k(()=>{this.updateTopicsList(this.topics,!1)}),this.sidebarTopicsList.setStudyMode(this.settings.isStudyModeEnabled(),this.topics,this.viewMode),this.settings.setStudyModeChangeCallback(e=>{this.sidebarTopicsList.setStudyMode(e,this.topics,this.viewMode)})}initialize(){this.sidebar=document.createElement("div"),this.sidebar.className="side-indexer-sidebar";const e=this.sidebarHeader.getElement();e&&this.sidebar.appendChild(e);const s=this.sidebarTabs.getElement();s&&this.sidebar.appendChild(s);const o=this.search.getContainer();o&&this.sidebar.appendChild(o);const t=this.sidebarTopicsList.getElement();t&&this.sidebar.appendChild(t),document.body.appendChild(this.sidebar),this.sidebarTabs.updateExpandCollapseButton(this.allExpanded),setTimeout(()=>{this.sidebar&&(this.sidebar.classList.add("sidebar-visible"),this.settings.setSidebarElement(this.sidebar)),document.body.classList.add("sidebar-active")},1e3),this.scanForTopics()}handleViewModeChange(e){this.viewMode=e,this.updateTopicsList(this.topics,!1)}observeChatChanges(){let e=null;window.location.hostname==="claude.ai"?e=document.querySelector('[data-testid="conversation-main"]')||document.querySelector('[data-scroller="true"]')||document.querySelector(".conversation-container")||document.querySelector(".flex.flex-col.gap-3")||document.querySelector(".flex.flex-col.items-start")||document.querySelector('[role="main"]')||document.body:e=document.querySelector('[data-testid="conversation-turn"]')?.parentElement||document.querySelector(".flex.flex-col")||document.querySelector('[data-testid="conversation-list"]')||document.querySelector(".conversation-container")||document.querySelector("#conversation-container")||document.body,console.log("Chat container found:",e?e.tagName:"none","on site:",window.location.hostname),e&&(this.observer=new MutationObserver(s=>{let o=!1;s.forEach(t=>{t.type==="childList"&&t.addedNodes.length>0&&(o=!0)}),o&&(console.log("Chat changes detected, scanning for topics..."),this.scanForTopics())}),this.observer.observe(e,{childList:!0,subtree:!0,characterData:!1}),setTimeout(()=>this.scanForTopics(),500))}scanForTopics(){console.log("üîç Scanning for topics on:",window.location.hostname),this.topics=[];let e;if(window.location.hostname==="claude.ai"){let t=document.querySelectorAll('[data-testid*="message"], [data-message-id], .group[data-message-id]');t.length===0&&(t=document.querySelectorAll('[class*="font-user-message"], [class*="font-claude-message"], [class*="font-assistant-message"]')),console.log(`Found ${t.length} Claude message containers`);const a=new Set;t.forEach(i=>{const n=[".prose",".whitespace-pre-wrap","p","div","span"];for(const l of n)i.querySelectorAll(l).forEach(h=>{const d=h.textContent?.trim();d&&d.length>10&&!d.includes("Sonnet")&&!d.includes("model")&&!d.includes("Claude.ai")&&!d.includes("Save")&&!d.includes("Copy")&&!d.includes("Regenerate")&&a.add(h)});if(i.querySelectorAll(".prose, .whitespace-pre-wrap, p, div, span").length===0){const l=i.textContent?.trim();l&&l.length>10&&!l.includes("Sonnet")&&!l.includes("model")&&!l.includes("Save")&&!l.includes("Copy")&&a.add(i)}}),e=Array.from(a),console.log(`Extracted ${e.length} Claude content elements`)}else if(e=document.querySelectorAll('[data-testid="conversation-turn"]'),e.length===0){const t=["[data-message-author-role]",".message",".conversation-message",'[role="message"]',".user-message",".assistant-message","[data-message-role]",".chat-message",".message-wrapper",".conversation-item"];for(const a of t)if(e=document.querySelectorAll(a),e.length>0){console.log(`Found ${e.length} conversation elements using selector: ${a}`);break}}else console.log("Found conversation turns:",e.length);const s=new Set;e.forEach(t=>{let a=!1,i=!1,n=t.textContent?.trim()||"";if(!s.has(n)){if(window.location.hostname==="claude.ai"){let l=t;t.matches('[data-testid*="message"], [data-message-id], [class*="font-user-message"], [class*="font-claude-message"]')||(l=t.closest('[data-testid*="message"], [data-message-id], [class*="font-user-message"], [class*="font-claude-message"]')||t);const c=l.getAttribute("data-message-role"),h=l.getAttribute("data-is-user-message"),d=l.getAttribute("data-message-id"),u=l.className;if((c==="user"||h==="true"||u.includes("font-user-message")||l.matches('[class*="font-user-message"]'))&&(a=!0),(c==="assistant"||h==="false"||u.includes("font-claude-message")||u.includes("font-assistant-message")||l.matches('[class*="font-claude-message"]')||l.matches('[class*="font-assistant-message"]'))&&(i=!0),!a&&!i){const r=n.toLowerCase(),g=t.className.toLowerCase();g.includes("font-user-message")||g.includes("user-message")?a=!0:g.includes("font-claude-message")||g.includes("font-assistant-message")||g.includes("claude-message")||g.includes("assistant-message")?i=!0:n&&n.length>10&&(r.length<50&&(r.includes("sonnet")||r.includes("claude.ai")||r.includes("model")||r.includes("save")||r.includes("copy")||r.includes("regenerate"))?console.log("Skipping likely header/metadata:",n.substring(0,30)+"..."):r.includes("i'm claude")||r.includes("as claude")||r.includes("here's")||r.includes("i'll help")||r.includes("i can help")||r.includes("let me")||r.includes("i'd be happy to")||r.includes("claude")&&r.length>100?i=!0:(r.includes("you said:")||r.includes("you:")||r.length<500&&!r.includes("here's")&&!r.includes("i'll")&&!r.includes("i can"))&&(a=!0))}(a||i)&&console.log(`Claude message detected - ${a?"USER":"AI"}:`,{role:c,isUserMessage:h,messageId:d,classes:t.className,preview:n.substring(0,50)+"..."})}else if((t.querySelector('[data-message-author-role="user"]')||t.querySelector('[data-message-role="user"]')||t.classList.contains("user")||t.closest('[data-message-author-role="user"]')||n.includes("You :")||t.getAttribute("data-message-author-role")==="user")&&(a=!0),(t.querySelector('[data-message-author-role="assistant"]')||t.querySelector('[data-message-role="assistant"]')||t.classList.contains("assistant")||t.closest('[data-message-author-role="assistant"]')||n.includes("Assistant:")||n.includes("AI :")||t.getAttribute("data-message-author-role")==="assistant")&&(i=!0),!a&&!i&&n){const l=n.toLowerCase();l.includes("you:")||l.includes("user:")||l.includes("human:")?a=!0:(l.includes("assistant:")||l.includes("ai:")||l.includes("bot:"))&&(i=!0)}if(a||i){let l;window.location.hostname==="claude.ai"?l=["You said:","You:","Claude:","Assistant:","Human:","User:","AI:","Assistant:","Bot:","Claude AI:"]:l=["You:","Assistant:","User:","AI:","Human:","Assistant:","Bot:"];for(const h of l)if(n.toLowerCase().startsWith(h.toLowerCase())){n=n.substring(h.length).trim();break}const c=n.length>60?n.substring(0,60)+"...":n||"Empty message";console.log(`Found ${a?"user":"AI"} message:`,c.substring(0,30)+"..."),this.topics.push({text:c,level:1,element:t,type:a?"user":"ai"}),s.add(n)}}});let o;window.location.hostname==="claude.ai"?o=document.querySelectorAll('[data-message-role], [data-testid="conversation-turn"], .group, .markdown, .message-container, [data-message-id]'):o=document.querySelectorAll('[data-testid="conversation-turn"], .group, .markdown'),o.forEach(t=>{t.querySelectorAll("h1, h2, h3, h4, h5, h6").forEach(i=>{const n=i.textContent?.trim();if(n&&n.length>2&&n.length<100){const l=parseInt(i.tagName.charAt(1))||1;this.topics.push({text:n,level:l,element:i})}})}),this.topics.length===0&&(document.body.textContent||"").split(`
`).forEach(i=>{const n=i.trim();if(n.length>5&&n.length<100){const l=n.match(/^(#{1,6})\s+(.+)$/);l&&this.topics.push({text:l[2],level:l[1].length,element:document.body})}}),this.topics=this.topics.filter((t,a,i)=>a===i.findIndex(n=>n.text===t.text)).slice(0,25),this.updateTopicsList(this.topics,!1),this.search.setTopics(this.topics)}updateTopicsList(e,s=!1){this.sidebarTopicsList.updateTopicsList(e,this.viewMode,s)}showSidebar(){this.sidebar&&(this.sidebar.classList.add("sidebar-visible"),document.body.classList.add("sidebar-active"))}hideSidebar(){this.sidebar&&(this.sidebar.classList.remove("sidebar-visible"),document.body.classList.remove("sidebar-active"))}isSidebarVisible(){return this.sidebar?.classList.contains("sidebar-visible")||!1}manualScan(){console.log("Manual scan triggered"),this.scanForTopics()}debugClaude(){console.log("üîß Claude.ai Debug Information:"),console.log("Current hostname:",window.location.hostname),console.log("Available selectors:"),["[data-message-role]",'[data-testid*="message"]',".group[data-message-id]",".font-user-message",".font-claude-message",".font-assistant-message",'[class*="font-user-message"]','[class*="font-claude-message"]','[class*="font-assistant-message"]',".prose",".whitespace-pre-wrap",'[class*="prose"]','[class*="whitespace-pre-wrap"]',"[data-is-user-message]",".message-container",'div[role="group"]','div[class*="message"]'].forEach(s=>{const o=document.querySelectorAll(s);if(o.length>0){console.log(`‚úÖ ${s}: ${o.length} elements found`);const t=o[0];console.log("   First element:",{tagName:t.tagName,className:t.className,attributes:Array.from(t.attributes).map(a=>`${a.name}="${a.value}"`),textPreview:t.textContent?.substring(0,100)+"..."})}else console.log(`‚ùå ${s}: 0 elements found`)}),console.log("Current topics found:",this.topics.length),this.topics.forEach((s,o)=>{console.log(`${o+1}. ${s.type}: ${s.text.substring(0,50)}...`)})}toggleExpandAll(){this.allExpanded?(this.sidebarTopicsList.toggleExpandAll(!0),this.allExpanded=!1,this.sidebarTabs.updateExpandCollapseButton(!1)):(this.sidebarTopicsList.toggleExpandAll(!1),this.allExpanded=!0,this.sidebarTabs.updateExpandCollapseButton(!0))}}class A{sidebar;constructor(){this.sidebar=new M,this.init()}init(){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{this.sidebar.initialize(),this.sidebar.observeChatChanges()}):(this.sidebar.initialize(),this.sidebar.observeChatChanges())}showSidebar(){this.sidebar.showSidebar()}hideSidebar(){this.sidebar.hideSidebar()}isSidebarVisible(){return this.sidebar.isSidebarVisible()}}const m=new A;v.onMessage.addListener((p,e,s)=>(p.action==="toggleSidebar"?(m.isSidebarVisible()?m.hideSidebar():m.showSidebar(),s({visible:m.isSidebarVisible()})):p.action==="getSidebarState"?s({visible:m.isSidebarVisible()}):p.action==="showSidebar"&&(m.showSidebar(),s({visible:!0})),!0));
